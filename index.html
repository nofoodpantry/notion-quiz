<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Notion Quiz</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    button { padding: 8px 12px; cursor: pointer; }
    .muted { color: #666; font-size: 0.9em; }
    .answer { margin-top: 6px; }
    .correct { color: #116611; }
    .wrong { color: #aa2222; }
    .hidden { display: none; }
    .options label { display: block; margin: 4px 0; }
    .badge { display: inline-block; background: #f3f3f3; border: 1px solid #ddd; padding: 2px 6px; border-radius: 999px; margin-right: 6px;}
  </style>
</head>
<body>
  <h1>Quiz</h1>

  <div class="card">
    <div class="controls">
      <div>
        <strong>Lectures:</strong>
        <label><input type="checkbox" class="lecture" value="L1" checked> L1</label>
        <label><input type="checkbox" class="lecture" value="L2" checked> L2</label>
        <label><input type="checkbox" class="lecture" value="L3" checked> L3</label>
        <label><input type="checkbox" class="lecture" value="L4" checked> L4</label>
        <label><input type="checkbox" class="lecture" value="L5" checked> L5</label>
        <label><input type="checkbox" class="lecture" value="L6" checked> L6</label>
        <label><input type="checkbox" class="lecture" value="L7" checked> L7</label>
        <label><input type="checkbox" class="lecture" value="L8" checked> L8</label>
      </div>
      <div>
        <label>Count
          <input id="count" type="number" min="1" max="50" value="20" style="width: 64px">
        </label>
      </div>
      <button id="start">Start quiz</button>
      <span id="status" class="muted"></span>
    </div>
    <div class="muted">Randomly picks the specified number from your Quiz database.</div>
  </div>

  <form id="quiz"></form>

  <div id="results" class="card hidden">
    <h3>Results</h3>
    <div id="scoreline"></div>
    <div id="answers"></div>
  </div>

<script>
const defaultLectureIdMap = JSON.parse(localStorage.getItem("lectureIdMap") || "{}");

async function ensureLectureMap() {
  const need = ["L1","L2","L3","L4","L5","L6","L7","L8"].filter(k => !defaultLectureIdMap[k]);
  if (!need.length) return defaultLectureIdMap;
  alert("First-time setup: paste Notion page IDs for L1–L8 (the long hex from each lecture page URL).");
  for (const k of need) {
    const v = prompt(`Paste Notion page ID for ${k}`, "");
    if (v) defaultLectureIdMap[k] = v.trim();
  }
  localStorage.setItem("lectureIdMap", JSON.stringify(defaultLectureIdMap));
  return defaultLectureIdMap;
}

function renderQuestion(q, idx) {
  const wrap = document.createElement("div");
  wrap.className = "card";
  const header = document.createElement("div");
  header.innerHTML = `<strong>Q${idx+1}.</strong> ${q.question} <span class="badge">${q.type || ""}</span>`;
  wrap.appendChild(header);

  const inputName = `q_${idx}`;
  if ((q.type || "").toLowerCase().includes("mcq")) {
    const options = q.options || [];
    const list = document.createElement("div");
    list.className = "options";
    options.forEach((opt, i) => {
      const letter = String.fromCharCode(65 + i);
      const id = `${inputName}_${letter}`;
      const label = document.createElement("label");
      label.htmlFor = id;
      label.innerHTML = `<input type="radio" name="${inputName}" id="${id}" value="${letter}"> ${letter}. ${opt}`;
      list.appendChild(label);
    });
    wrap.appendChild(list);
  } else {
    const input = document.createElement("input");
    input.type = "text";
    input.name = inputName;
    input.placeholder = "Your answer";
    input.style.width = "100%";
    input.autocomplete = "off";
    wrap.appendChild(input);
    const hint = document.createElement("div");
    hint.className = "muted";
    hint.textContent = "Short answer. Any one acceptable answer is counted correct.";
    wrap.appendChild(hint);
  }

  const meta = document.createElement("div");
  meta.className = "hidden";
  meta.dataset.id = q.id;
  meta.dataset.type = q.type;
  meta.dataset.correct = q.correct;
  meta.dataset.options = (q.options || []).join("||");
  wrap.appendChild(meta);

  return wrap;
}

function getSelectedLectures() {
  const checks = Array.from(document.querySelectorAll(".lecture"));
  return checks.filter(c => c.checked).map(c => c.value);
}

function mapLecturesToIds(selected, map) {
  return selected.map(k => map[k]).filter(Boolean);
}

document.getElementById("start").addEventListener("click", async () => {
  const status = document.getElementById("status");
  status.textContent = "Loading…";
  const lectureMap = await ensureLectureMap();
  const selectedLectures = getSelectedLectures(); // e.g., ["L1","L3","L5"]
  }

  const count = Math.max(1, Math.min(parseInt(document.getElementById("count").value || "20", 10), 50));

  const params = new URLSearchParams();
  params.set("count", count);
  params.set("lectureTitles", selectedLectures.join(","));
  const res = await fetch(/.netlify/functions/get-questions?${params.toString()});
  if (!res.ok) { alert("Failed to fetch questions."); status.textContent = ""; return; }
  const data = await res.json();

  const form = document.getElementById("quiz");
  form.innerHTML = "";
  data.items.forEach((q, idx) => form.appendChild(renderQuestion(q, idx)));

  const submit = document.createElement("button");
  submit.type = "button";
  submit.textContent = "Submit answers";
  submit.addEventListener("click", async () => {
    const payload = [];
    const cards = Array.from(document.querySelectorAll("#quiz .card"));
    cards.forEach((card, idx) => {
      const meta = card.querySelector("div.hidden");
      const id = meta.dataset.id;
      const type = meta.dataset.type;
      const correct = meta.dataset.correct;
      const options = (meta.dataset.options || "").split("||").filter(Boolean);
      const name = `q_${idx}`;
      let ua = "";

      if ((type || "").toLowerCase().includes("mcq")) {
        const chosen = document.querySelector(`input[name="${name}"]:checked`);
        ua = chosen ? chosen.value : "";
      } else {
        const input = document.querySelector(`input[name="${name}"]`);
        ua = input ? input.value : "";
      }
      payload.push({ id, type, correct, userAnswer: ua, options });
    });

    const scoreRes = await fetch("/.netlify/functions/score-quiz", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ items: payload })
    });
    if (!scoreRes.ok) { alert("Scoring failed."); return; }
    const result = await scoreRes.json();

    const resultsDiv = document.getElementById("results");
    resultsDiv.classList.remove("hidden");
    document.getElementById("scoreline").textContent = `Score: ${result.score} / ${result.total}`;
    const answers = document.getElementById("answers");
    answers.innerHTML = "";
    result.details.forEach((d, i) => {
      const line = document.createElement("div");
      line.className = "answer";
      line.innerHTML = `Q${i+1}: <span class="${d.isCorrect ? "correct" : "wrong"}">${d.isCorrect ? "Correct" : "Wrong"}</span> — Correct answer: ${d.correctAnswer || "(none)"}`;
      answers.appendChild(line);
    });
    window.scrollTo({ top: resultsDiv.offsetTop - 12, behavior: "smooth" });
  });
  form.appendChild(submit);
  status.textContent = "";
});
</script>
</body>
</html>